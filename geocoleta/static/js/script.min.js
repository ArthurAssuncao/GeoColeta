function limpar_registros(){info_window.setMap(null);for(var t in lista_desc)lista_desc[t].setMap(null);lista_desc=[]}function info_coletor(t){var e=coletores[t];info_window.setPosition(new google.maps.LatLng(e[0]+15e-5,e[1])),info_window.setContent('<h2 class="titulo_window">'+e[2]+"</h2><strong>Resíduos: </strong> <span>"+e[3].join("</span>, <span>")+".</span>"),Lungo.Aside.hide(),info_window.open(map),map.setCenter(info_window.getPosition())}function info_local(t,e){var i=locais[t];info_window.setPosition(e),Lungo.Aside.hide(),cache_texto_locais[t]?(info_window.setContent('<h2 class="titulo_window">'+i[0]+'</h2><span class="descricao">'+cache_texto_locais[t])+"</span>",info_window.open(map)):(msg_carregando(),Lungo.Service.get("ajax_local/"+t,"",function(o){cache_texto_locais[t]=o,info_window.setPosition(e),info_window.setContent('<h2 class="titulo_window">'+i[0]+'</h2><span class="descricao">'+cache_texto_locais[t]+"</span>"),info_window.open(map)},"text")),map.setCenter(e)}function confirmar_descarte(t){msg_carregando(),Lungo.Service.get(t,"",function(){info_window.setContent('<strong>Obrigado por colaborar com o estudo do processo de coleta seletiva no Câmpus!</strong><br><br>Compartilhe no <a class="link-social" data-icon="facebook-sign" target="_blank" href="http://www.facebook.com/sharer.php?u=http://geocoleta.org" target="_blank">Facebook</a>, <a class="link-social" href="https://twitter.com/intent/tweet?source=tweetbutton&text=Estou contribuindo com o processo de coleta seletiva no IF Barbacena&url=http://geocoleta.org" target="_blank">Twitter</a> ou <a class="link-social" href="https://plus.google.com/share?url=geocoleta.org" target="_blank">G+</a>!'),info_window.open(map)},"json")}function gerar_grafico(t){msg_carregando(),Lungo.Service.get("ajax_grafico/"+t,"",function(e){var i=coletores[t];return info_window.setMap(null),info_window.setPosition(new google.maps.LatLng(i[0]+2e-4,i[1])),info_window.setContent('<h2 class="titulo_window" style="width: 95%">'+i[2]+'</h2><span><div id="container" style="width: 235px; height: 190px; margin: 0 auto"></div>'),info_window.open(map),map.setCenter(info_window.getPosition()),Lungo.Aside.hide(),e.length?($("#container").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,marginRight:15},title:!1,tooltip:{pointFormat:"<strong>{point.y}% dos descartes</strong>"},credits:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1},showInLegend:!0}},colors:["#214f83","#990000","#006654","#993300","#666666"],series:[{type:"pie",name:"Descartes",data:e}]}),void 0):(info_window.setContent('<h2 class="titulo_window">'+i[2]+"</h2>Não há registros de descarte para este coletor."),void 0)},"json")}function msg_carregando(){info_window.setPosition(new google.maps.LatLng(lat+2e-4,lng)),info_window.setContent('<img src="/static/img/loading.gif">'),info_window.open(map),map.setCenter(info_window.getPosition())}var lat=-21.227959,lng=-43.76627,TIMEOUT_LOCALIZACAO=500,TENTATIVAS=20,num_tentativa=0,localizado=!1,exibir_infra=!0,lista_locais=[],lista_desc=[],cache_texto_locais={},info_window=new google.maps.InfoWindow({maxWidth:window.innerWidth<=350?230:310}),html_menu_coletores="",html_menu_relatorios="",html_menu_locais="";Lungo.ready(function(){function t(){if(!localizado&&TENTATIVAS>num_tentativa)setTimeout(t,TIMEOUT_LOCALIZACAO),num_tentativa+=1;else{map=new google.maps.Map(document.getElementById("map-canvas"),{center:new google.maps.LatLng(lat,lng),zoom:18,mapTypeId:google.maps.MapTypeId.SATELLITE}),user=new google.maps.Marker({position:new google.maps.LatLng(lat,lng),map:map,draggable:!0}),google.maps.event.addListener(user,"dragend",function(){lat=user.getPosition().lat(),lng=user.getPosition().lng()}),google.maps.event.addListener(user,"dragstart",function(){info_window.setMap(null)}),info_window.setPosition(new google.maps.LatLng(lat+2e-4,lng)),1==localizado?info_window.setContent('<h2 class="titulo_window">Sua localização foi detectada:</h2><strong>Latitude: </strong>'+lat.toFixed(6)+" Sul<br><strong>Longitude: </strong>"+lng.toFixed(6)+" Oeste"):info_window.setContent('<h2 class="titulo_window">Não foi possível determinar sua localização!</h2>Arraste o marcador vermelho para alterá-la manualmente.'),info_window.open(map);for(var e in coletores){var i=new google.maps.Marker({position:new google.maps.LatLng(coletores[e][0],coletores[e][1]),map:map,animation:google.maps.Animation.DROP,icon:new google.maps.MarkerImage("/static/img/coletor.png"),id:e});google.maps.event.addListener(i,"click",function(){info_coletor(this.id)})}if(!locais.vazio)for(var e in locais){for(var o,a=[],n=new google.maps.LatLngBounds,s=0;s<locais[e][1].length;s++)o=new google.maps.LatLng(locais[e][1][s][0],locais[e][1][s][1]),a.push(o),n.extend(o);var r=new google.maps.Polygon({map:map,paths:a,strokeColor:"#7a5512",strokeOpacity:1,strokeWeight:1,fillColor:"#7a5512",fillOpacity:.5,position:n.getCenter(),id:e});locais[e].push(n.getCenter()),google.maps.event.addListener(r,"click",function(){info_local(this.id,this.position)}),lista_locais.push(r)}}}obter_localizacao=function(t){latitude=t.coords.latitude,longitude=t.coords.longitude,(-21.2296593!=latitude||-43.7715839!=longitude)&&(lat=latitude,lng=longitude,localizado=1)},callback_erro=function(){localizado=-1},navigator.geolocation.getCurrentPosition(obter_localizacao,callback_erro),t(),Lungo.Aside.show(),Lungo.dom("#fieldset_infra").tap(function(){for(var t=exibir_infra?null:map,e=0;e<lista_locais.length;e++)lista_locais[e].setMap(t);exibir_infra=exibir_infra?!1:!0});var e=Lungo.dom("#article_menu").html();voltar_menu=function(){Lungo.dom("#article_menu").html(e),Lungo.dom("#header_menu > h1").text("Ferramentas")},Lungo.dom("#opt_centralizar").tap(function(){map.setCenter(user.getPosition()),Lungo.Aside.hide()}),Lungo.dom("#opt_infra").tap(function(){if(!locais.vazio){if(Lungo.dom("#header_menu > h1").text("Infraestrutura"),""==html_menu_locais){var t="";for(var e in locais)t+='<li><a href="#" onclick="info_local('+e+",new google.maps.LatLng"+locais[e][2]+')"><p class="text small">'+locais[e][0]+"</p></a></li>";html_menu_locais='                <ul>                <li data-view-article="main-article">                    <a href="#" onclick="voltar_menu()">                        <strong>Voltar</strong>                    </a>                </li>'+t+'</ul><div style="visibility:hidden; text-indent:100%">0</div>'}Lungo.dom("#article_menu").html(html_menu_locais)}}),Lungo.dom("#opt_coletores").tap(function(){if(!coletores.vazio){if(Lungo.dom("#header_menu > h1").text("Coletores"),""==html_menu_coletores){var t="";for(var e in coletores)t+='<li><a href="#" onclick="info_coletor('+e+')"><p class="text small">'+coletores[e][2]+'</p><span class="tag">'+coletores[e][3].join('</span> <span class="tag">')+"</span></a></li>";html_menu_coletores='                <ul>                <li data-view-article="main-article">                    <a href="#" onclick="voltar_menu()">                        <strong>Voltar</strong>                    </a>                </li>'+t+"</ul>"}Lungo.dom("#article_menu").html(html_menu_coletores)}}),Lungo.dom("#opt_noticias").tap(function(){atualizar_menu("ajax_noticias")}),Lungo.dom("#opt_rel_descartes").tap(function(){Lungo.Aside.hide(),limpar_registros();var t=Lungo.dom("#txt_desc"),e="Limpar tela";return t.text()==e?(t.text("Descartes"),void 0):(msg_carregando(),t.text(e),Lungo.Service.get("ajax_descartes","",function(t){if(!t.length)return info_window.setContent("Não há registros de descartes!"),void 0;var e;for(i in t){e=t[i];var o=new google.maps.Marker({position:new google.maps.LatLng(e[0],e[1]),map:map,animation:google.maps.Animation.DROP,icon:new google.maps.MarkerImage("/static/img/marker"+e[3]+".png"),data:e[2],tipo:e[4],desc:e[5]});lista_desc.push(o),google.maps.event.addListener(o,"click",function(){info_window.setPosition(new google.maps.LatLng(this.position.lat()+2e-4,this.position.lng())),info_window.setContent('<h2 class="titulo_window">'+this.data+'</h2><div style="width: 98%">Resíduo do tipo <strong>'+this.tipo.toLowerCase()+'</strong> descartado no coletor <strong>"'+this.desc+'"</strong>.</div>'),info_window.open(map)})}map.setCenter(new google.maps.LatLng(e[0],e[1])),info_window.setMap(null)},"json"),void 0)}),Lungo.dom("#opt_rel_coletores").tap(function(){if(!coletores.vazio){if(Lungo.dom("#header_menu > h1").text("Relatórios"),""==html_menu_relatorios){var t="";for(var e in coletores)t+='<li><a href="#" onclick="gerar_grafico('+e+')"><p class="text small">'+coletores[e][2]+'</p><span class="tag blue">'+coletores[e][3].join('</span> <span class="tag blue">')+"</span></a></li>";html_menu_relatorios='                <ul>                <li data-view-article="main-article">                    <a href="#" onclick="voltar_menu()">                        <strong>Voltar</strong>                    </a>                </li>'+t+"</ul>"}Lungo.dom("#article_menu").html(html_menu_relatorios)}}),Lungo.dom("nav#descarte a").tap(function(){Lungo.Aside.hide(),msg_carregando();var t="ajax_descarte/"+lat+"/"+lng+"/"+Lungo.dom(this)[0].id;Lungo.Service.get(t+"/0","",function(e){if(0==e.id_coletor)info_window.setContent("Não foram encontrados coletores próximos com suporte a este tipo de resíduo.");else{var i=coletores[e.id_coletor],o=e.distancia;info_window.setPosition(new google.maps.LatLng(i[0]+15e-5,i[1])),info_window.setContent('<h2 class="titulo_window">'+i[2]+"</h2><strong>Resíduos:</strong> <span>"+i[3].join("</span>, <span>")+'</span>.<div style="text-align: center"><div style="font-size: 30px; color: #333; text-shadow: 1px 1px #aaa;">'+o.toString().replace(".",",")+'</div><div style="letter-spacing: 1px">METROS</div><button style="margin-top: 15px;" onclick="confirmar_descarte(\''+t+"/"+e.id_coletor+"')\">Confirmar descarte</button></div>")}info_window.open(map),map.setCenter(info_window.getPosition())},"json")}),window.addEventListener("orientationchange",function(){window.orientation?(Lungo.dom(".ocultar_h").hide(),info_window.maxWidth+=110):(Lungo.dom(".ocultar_h").show(),info_window.maxWidth-=110)},!1)});